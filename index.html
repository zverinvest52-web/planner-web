<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Planner</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F5F5F7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="stylesheet" href="style.css?v=49.4">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body class="light-theme">

    <!-- Pull to Refresh Indicator -->
    <div class="pull-indicator" id="pull-indicator">
        <i class="fas fa-sync-alt pull-icon"></i>
        <span class="pull-text" id="pull-text">–ü–æ—Ç—è–Ω–∏—Ç–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</span>
    </div>

    <!-- Error Handler for Debugging -->
    <script>
        window.onerror = function (msg, url, line, col, error) {
            alert("Global Error:\n" + msg + "\nLine: " + line + "\nURL: " + url);
            return false;
        };

        // Force Version Check
        const CURRENT_VERSION = '49.4';
        if (localStorage.getItem('app_version') !== CURRENT_VERSION) {
            localStorage.setItem('app_version', CURRENT_VERSION);
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function (registrations) {
                    for (let registration of registrations) {
                        registration.unregister();
                    }
                    window.location.reload(true);
                });
            }
        }
    </script>
    <!-- Main Screen -->
    <div id="app" class="app-container">

        <!-- Header -->
        <header class="main-header">
            <div class="header-row">
                <div class="date-container-center">
                    <h1 id="header-date">–°–µ–≥–æ–¥–Ω—è</h1>
                </div>
                <!-- Search Removed -->
            </div>
            <!-- Collapsible Search Removed from view -->
            <div class="search-bar hidden" id="search-bar-container">
                <i class="fas fa-search"></i>
                <input type="text" id="global-search" placeholder="–ü–æ–∏—Å–∫ –∑–∞–¥–∞—á...">
            </div>
        </header>

        <!-- Category Stack -->
        <div class="category-stack" id="category-stack">
            <!-- Categories will be injected here -->
        </div>

        <!-- Categories View (Tab) -->
        <div class="view-container hidden" id="view-cats">
            <div class="view-header">
                <div class="subtitle">–ü–ê–ü–ö–ò</div>
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ<br>–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</h2>
            </div>
            <div class="hint-text">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –∏ —Ç—è–Ω–∏—Ç–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</div>
            <div id="cats-list-container"></div>
            <button class="btn-primary" onclick="addNewCatPrompt()">+ –ù–û–í–ê–Ø –ü–ê–ü–ö–ê</button>
        </div>

        <!-- Spacer for Dock -->
        <div class="dock-spacer"></div>

        <!-- Bottom Dock -->
        <div class="bottom-dock">
            <button class="dock-btn active" id="nav-home" onclick="switchTab('home')">
                <i class="fas fa-home"></i>
            </button>

            <button class="dock-fab" onclick="openAddTaskModal()">
                <i class="fas fa-plus"></i>
            </button>

            <button class="dock-btn" id="nav-cats" onclick="switchTab('cats')">
                <i class="fas fa-folder"></i>
            </button>
        </div>

    </div>

    <!-- View Task Modal (New Design) -->
    <div id="modal-view-task" class="modal overlay hidden">
        <div class="modal-card">
            <!-- Header Actions -->
            <div class="modal-view-header">
                <div class="badge-category" id="view-category-badge">–û–ë–©–ò–ï</div>
                <div class="header-right-actions">
                    <button id="btn-view-edit-top" class="btn-text-accent">–ò–ó–ú–ï–ù–ò–¢–¨</button>
                    <button id="btn-close-view" class="btn-icon circle-btn"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <div class="view-scroll-content">
                <!-- Title -->
                <h1 id="view-title" class="view-task-title">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</h1>

                <!-- Time & Date -->
                <div class="view-meta-row">
                    <div id="view-time-container" class="meta-pill hidden">
                        <i class="far fa-clock"></i> <span id="view-time-val"></span>
                    </div>
                    <div id="view-date-container" class="meta-pill hidden">
                        <i class="far fa-calendar"></i> <span id="view-date-val"></span>
                    </div>
                </div>

                <!-- Description -->
                <div id="view-desc-block" class="view-block hidden">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <div id="view-desc-text" class="view-text-content"></div>
                </div>

                <!-- Tags -->
                <div id="view-tags-block" class="view-block hidden">
                    <label>–¢–µ–≥–∏</label>
                    <div id="view-tags-text" class="view-tags-content"></div>
                </div>

                <!-- Gallery -->
                <div id="view-gallery-block" class="view-block hidden">
                    <label>–í–ª–æ–∂–µ–Ω–∏—è</label>
                    <div class="gallery-container">
                        <div class="gallery-track" id="view-gallery-track">
                            <!-- Photos injected via JS -->
                        </div>
                        <div class="gallery-indicators" id="view-gallery-dots"></div>
                    </div>
                </div>
            </div>

            <!-- Footer Actions -->
            <div class="view-footer">
                <button id="btn-view-delete" class="btn-text-danger">–£–¥–∞–ª–∏—Ç—å</button>
                <div class="spacer"></div>
                <button id="btn-view-complete" class="btn-primary-red">–í–´–ü–û–õ–ù–ò–¢–¨</button>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal overlay hidden" id="modal-add-task">
        <div class="modal-card">
            <div class="modal-header">
                <h2 id="modal-title">–ù–û–í–ê–Ø –ó–ê–î–ê–ß–ê</h2>
                <button class="close-btn" id="close-add-task"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body wizard-container">

                <!-- STEP 1: TITLE & DESCRIPTION -->
                <div class="wizard-step" id="wizard-step-1">
                    <div class="step-header">–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?</div>
                    <div class="title-input-wrapper">
                        <input type="text" id="input-title" class="input-large" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏"
                            autocomplete="off">
                        <button class="voice-input-btn" id="btn-voice-input" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>

                    <!-- Quick Templates -->
                    <div class="templates-section">
                        <div class="templates-label">–ë—ã—Å—Ç—Ä—ã–µ —à–∞–±–ª–æ–Ω—ã:</div>
                        <div class="chips-row" id="templates-container">
                            <button class="chip" onclick="applyTemplate('–ö—É–ø–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã')">üõí –ü—Ä–æ–¥—É–∫—Ç—ã</button>
                            <button class="chip" onclick="applyTemplate('–ü–æ–∑–≤–æ–Ω–∏—Ç—å –≤ –±–∞–Ω–∫')">üìû –ó–≤–æ–Ω–æ–∫</button>
                            <button class="chip" onclick="applyTemplate('–í—Å—Ç—Ä–µ—á–∞')">üë• –í—Å—Ç—Ä–µ—á–∞</button>
                            <button class="chip" onclick="applyTemplate('–°–ø–æ—Ä—Ç')">üí™ –°–ø–æ—Ä—Ç</button>
                        </div>
                    </div>

                    <div class="desc-box">
                        <textarea id="input-desc" class="input-area" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ / –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
                    </div>
                </div>

                <!-- STEP 2: PHOTOS -->
                <div class="wizard-step hidden" id="wizard-step-2">
                    <div class="step-header">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</div>
                    <div class="photo-upload-container">
                        <button class="btn-add-photo-large" id="btn-add-photo-wizard">
                            <i class="fas fa-plus"></i>
                            <span>–î–æ–±–∞–≤–∏—Ç—å</span>
                        </button>
                        <input type="file" id="input-photo-native" multiple accept="image/*" class="hidden">
                    </div>
                    <div id="photos-preview-container" class="photos-grid"></div>
                    <div class="step-hint">–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ 5 —Ñ–æ—Ç–æ</div>
                </div>

                <!-- STEP 3: DATE & TIME -->
                <div class="wizard-step hidden" id="wizard-step-3">
                    <div class="step-header">–î–∞—Ç–∞ –∏ –í—Ä–µ–º—è</div>

                    <div class="input-row clickable" id="btn-pick-date">
                        <div class="row-left">
                            <i class="fas fa-calendar-alt accent-icon"></i>
                            <span id="label-date">–í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É</span>
                        </div>
                        <button class="clear-date hidden" id="btn-clear-date"><i class="fas fa-times"></i></button>
                    </div>

                    <div class="input-row">
                        <i class="far fa-clock text-gray"></i>
                        <input type="time" id="input-time" class="input-transparent">
                    </div>
                </div>

                <!-- STEP 4: SETTINGS -->
                <div class="wizard-step hidden" id="wizard-step-4">
                    <div class="step-header">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>

                    <div class="input-row clickable relative" id="btn-pick-cat">
                        <div class="row-left">
                            <span class="text-gray">–ü–∞–ø–∫–∞:</span>
                            <span id="label-cat" class="text-dark bold">–û–ë–©–ò–ï</span>
                        </div>
                        <i class="fas fa-chevron-down text-gray small"></i>
                    </div>
                    <!-- Mini Dropdown for Categories -->
                    <div class="dropdown hidden" id="dropdown-cat"></div>

                    <div class="section-label" style="margin-top:24px;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                    <div class="chips-row">
                        <div class="chip selected" onclick="selectNotify(0, this)">–ù–µ—Ç</div>
                        <div class="chip" onclick="selectNotify(5, this)">5 –º–∏–Ω</div>
                        <div class="chip" onclick="selectNotify(15, this)">15 –º–∏–Ω</div>
                        <div class="chip" onclick="selectNotify(60, this)">1 —á–∞—Å</div>
                    </div>

                    <!-- Advanced Toggle -->
                    <div class="advanced-toggle" onclick="toggleAdvanced()"
                        style="margin-top:24px; display:flex; align-items:center; gap:8px; cursor:pointer;">
                        <span class="text-accent bold"
                            style="font-size:15px; color:var(--text-dark);">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</span>
                        <i class="fas fa-chevron-down text-gray small transition-icon" id="adv-chevron"
                            style="transition: transform 0.2s;"></i>
                    </div>

                    <!-- Advanced Content -->
                    <div id="advanced-settings" class="hidden"
                        style="margin-top:16px; padding-left:4px; border-left: 2px solid #F2F2F7; margin-left:8px;">

                        <div class="section-label" style="font-size:14px; margin-bottom:12px;">–ü–æ–≤—Ç–æ—Ä</div>
                        <div class="chips-row scroll-x" style="padding-bottom:10px;">
                            <div class="chip selected" onclick="selectRepeat('none', this)">–ù–µ—Ç</div>
                            <div class="chip" onclick="selectRepeat('daily', this)">–ö–∞–∂–¥—ã–π –¥–µ–Ω—å</div>
                            <div class="chip" onclick="selectRepeat('weekly', this)">–†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é</div>
                            <div class="chip" onclick="selectRepeat('monthly', this)">–†–∞–∑ –≤ –º–µ—Å—è—Ü</div>
                        </div>

                        <div class="input-row" style="margin-top:8px;">
                            <i class="fas fa-user-plus text-gray"></i>
                            <input type="text" placeholder="–£—á–∞—Å—Ç–Ω–∏–∫ (–∏–º—è)" class="input-transparent">
                        </div>
                    </div>
                </div>

                <!-- NAVIGATION FOOTER -->
                <div class="wizard-footer">
                    <button class="btn-nav secondary" id="btn-wizard-back">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn-nav primary" id="btn-wizard-next">–î–∞–ª–µ–µ</button>
                </div>

                <button class="hidden" id="btn-add-photo"></button> <!-- Legacy Hook Ref -->
                <button class="hidden" id="btn-save-task"></button> <!-- Legacy Hook Ref -->
            </div>
        </div>
    </div>

    <!-- Category Manager Modal -->
    <div class="modal overlay hidden" id="modal-manage-cats">
        <div class="modal-card">
            <div class="modal-header">
                <div style="display:flex; flex-direction:column;">
                    <span
                        style="font-size:12px; font-weight:600; color:#8E8E93; letter-spacing:1px; text-transform:uppercase;">–ü–ê–ü–ö–ò</span>
                    <h2 style="font-size:28px; line-height:1.1; margin:0; color:#000;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ<br>–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</h2>
                </div>
                <button class="close-btn" id="close-manage-cats"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div id="cats-list-container" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;"></div>
                <div class="input-row" style="border:none; padding:0; margin-bottom: 12px;">
                    <input type="text" id="input-new-cat" class="input-std" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —ç–º–æ–¥–∑–∏)"
                        style="margin-bottom:0; flex:1;">
                    <button class="dock-fab" id="btn-add-cat"
                        style="width:40px; height:40px; font-size:16px; margin-left:10px; box-shadow:none;"><i
                            class="fas fa-plus"></i></button>
                </div>
                <!-- Emoji picker -->
                <div class="emoji-picker">
                    <div class="emoji-label">–ë—ã—Å—Ç—Ä—ã–µ —ç–º–æ–¥–∑–∏:</div>
                    <div class="emoji-grid">
                        <span class="emoji-btn" onclick="addEmoji('üè†')">üè†</span>
                        <span class="emoji-btn" onclick="addEmoji('üíº')">üíº</span>
                        <span class="emoji-btn" onclick="addEmoji('üéØ')">üéØ</span>
                        <span class="emoji-btn" onclick="addEmoji('üí°')">üí°</span>
                        <span class="emoji-btn" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                        <span class="emoji-btn" onclick="addEmoji('‚ö°')">‚ö°</span>
                        <span class="emoji-btn" onclick="addEmoji('üé®')">üé®</span>
                        <span class="emoji-btn" onclick="addEmoji('üìö')">üìö</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal overlay hidden" id="modal-datepicker">
        <div class="modal-card compact">
            <input type="date" id="input-date-native">
            <div class="modal-actions">
                <button class="btn-text" id="btn-cancel-date">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-text accent" id="btn-confirm-date">–í–´–ë–†–ê–¢–¨</button>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div class="modal overlay hidden" id="modal-statistics">
        <div class="modal-card">
            <div class="modal-header">
                <h2>–°–¢–ê–¢–ò–°–¢–ò–ö–ê</h2>
                <button class="close-btn" id="close-stats"><i class="fas fa-times"></i></button>
            </div>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="stat-completed">0</div>
                    <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="stat-today">0</div>
                    <div class="stat-label">–ù–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-value" id="stat-overdue">0</div>
                    <div class="stat-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
                </div>
            </div>
            <div class="stats-progress">
                <div class="progress-label">–ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="stat-progress"></div>
                </div>
                <div class="progress-percent" id="stat-percent">0%</div>
            </div>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div class="modal overlay hidden" id="modal-onboarding">
        <div class="modal-card" style="max-width: 350px;">
            <div class="modal-header">
                <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
            </div>
            <div class="onboarding-content">
                <div class="onboarding-step">
                    <div class="onboarding-icon">‚ûï</div>
                    <div class="onboarding-text">
                        <strong>–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á</strong><br>
                        –ù–∞–∂–º–∏—Ç–µ –∫—Ä–∞—Å–Ω—É—é –∫–Ω–æ–ø–∫—É + –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞
                    </div>
                </div>
                <div class="onboarding-step">
                    <div class="onboarding-icon">‚úÖ</div>
                    <div class="onboarding-text">
                        <strong>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</strong><br>
                        –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫—Ä—É–∂–æ–∫ —Å–ª–µ–≤–∞ –æ—Ç –∑–∞–¥–∞—á–∏ –∏–ª–∏ —Å–≤–∞–π–ø–Ω–∏—Ç–µ –≤–ø—Ä–∞–≤–æ
                    </div>
                </div>
                <div class="onboarding-step">
                    <div class="onboarding-icon">üëà</div>
                    <div class="onboarding-text">
                        <strong>–£–¥–∞–ª–µ–Ω–∏–µ</strong><br>
                        –°–≤–∞–π–ø–Ω–∏—Ç–µ –∑–∞–¥–∞—á—É –≤–ª–µ–≤–æ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                    </div>
                </div>
                <div class="onboarding-step">
                    <div class="onboarding-icon">üìä</div>
                    <div class="onboarding-text">
                        <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</strong><br>
                        –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É –≥—Ä–∞—Ñ–∏–∫–æ–≤ –≤ –º–µ–Ω—é
                    </div>
                </div>
            </div>
            <button class="btn-primary" id="btn-close-onboarding">–ü–æ–Ω—è—Ç–Ω–æ!</button>
        </div>
    </div>

    <!-- Undo Toast -->
    <div id="undo-toast" class="undo-toast hidden">
        <div class="toast-content">
            <span id="toast-message">–î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
            <button id="undo-btn" class="undo-btn">–û—Ç–º–µ–Ω–∏—Ç—å (<span id="undo-countdown">5</span>—Å)</button>
        </div>
    </div>

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <!-- Config -->
    <script src="firebase-config.js?v=52.5"></script>

    <!-- Scripts -->
    <script src="app.js?v=52.5"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js?v=52.5').then(reg => {
                reg.update();
            });
        }
    </script>
</body>

</html>